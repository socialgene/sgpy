import os
import tempfile
from socialgene.hmm.hmminfo import HmmInfo

FIXTURE_DIR = os.path.dirname(os.path.realpath(__file__))
FIXTURE_DIR = os.path.dirname(FIXTURE_DIR)
FIXTURE_DIR = os.path.join(FIXTURE_DIR, "data")
# FIXTURE_DIR = "/home/chase/Documents/github/kwan_lab/socialgene/sgpy/tests/python/data"
hmm_metadata = os.path.join(FIXTURE_DIR, "hmm_metadata.tsv.gz")


def test_read():
    expected = [
        (
            "amrfinder_0",
            "amrfinder",
            "vanR-C-NCBIFAM.socialgene.hmm.gz",
            "vanR-C-NCBIFAM",
            "NF000403.1",
            "",
            "NCBIFAM: VanC-type vancomycin resistance DNA-binding response regulator VanR",
            "Tue Aug 27 12:40:23 2019",
            "apGY0trpuFsy-yHsEO9UISlrhQx6TTLC",
            "apGY0trpuFsy-yHsEO9UISlrhQx6TTLC",
            "698",
            "",
            "",
            "480.00 480.00",
            "480.00 480.00",
            "480.00 480.00",
        ),
        (
            "amrfinder_1",
            "amrfinder",
            "FosU-NCBIFAM.socialgene.hmm.gz",
            "FosU-NCBIFAM",
            "NF038311.1",
            "",
            "NCBIFAM: FosU family fosfomycin resistance glutathione transferase",
            "Mon Jan 25 07:38:26 2021",
            "9aoKRGqW5_z5zcCH8wulWF5an7D48XmM",
            "9aoKRGqW5_z5zcCH8wulWF5an7D48XmM",
            "416",
            "",
            "",
            "295.00 295.00",
            "295.00 295.00",
            "250.00 250.00",
        ),
        (
            "amrfinder_2",
            "amrfinder",
            "blaOXA-60_like-NCBIFAM.socialgene.hmm.gz",
            "blaOXA-60_like-NCBIFAM",
            "NF000395.3",
            "",
            "NCBIFAM: OXA-60 family carbapenem-hydrolyzing class D beta-lactamase",
            "Tue Aug 27 12:38:06 2019",
            "vm8e9Y4xr6ioruVr7_GbwrvvHjdVdi4e",
            "vm8e9Y4xr6ioruVr7_GbwrvvHjdVdi4e",
            "818",
            "",
            "",
            "550.00 550.00",
            "550.00 550.00",
            "480.00 480.00",
        ),
        (
            "pfam_628",
            "pfam",
            "Pfam-A.socialgene.hmm.gz",
            "1-cysPrx_C",
            "PF10417.12",
            "",
            "C-terminal domain of 1-Cys peroxiredoxin",
            "Thu Nov  4 19:20:02 2021",
            "Z4Wkzo7ip6X5PBcNX8oZFu0VpW8QOb3F",
            "Z4Wkzo7ip6X5PBcNX8oZFu0VpW8QOb3F",
            "125",
            "",
            "",
            "21.10 21.10",
            "21.10 21.10",
            "21.00 21.00",
        ),
        (
            "pfam_629",
            "pfam",
            "Pfam-A.socialgene.hmm.gz",
            "120_Rick_ant",
            "PF12574.11",
            "",
            "120 KDa Rickettsia surface antigen",
            "Tue Oct 12 02:07:11 2021",
            "NYiHn06Ms9lNw60zW13-sObNQrDXs4e7",
            "NYiHn06Ms9lNw60zW13-sObNQrDXs4e7",
            "719",
            "",
            "",
            "25.00 25.00",
            "39.80 39.60",
            "23.60 21.20",
        ),
        (
            "pfam_630",
            "pfam",
            "Pfam-A.socialgene.hmm.gz",
            "12TM_1",
            "PF09847.12",
            "",
            "Membrane protein of 12 TMs",
            "Wed Oct 20 15:13:22 2021",
            "YR6F0nKMKCDSa43uLFirmdKy4vW_EbjM",
            "YR6F0nKMKCDSa43uLFirmdKy4vW_EbjM",
            "1352",
            "",
            "",
            "33.20 33.20",
            "33.60 33.20",
            "33.10 32.90",
        ),
        (
            "antismash_20260",
            "antismash",
            "antismash/modules/lassopeptides/data/tail_cut.socialgene.hmm.gz",
            "tails10",
            "",
            "",
            "",
            "Sun Jun 12 00:39:01 2016",
            "c5SwFf_lISLiNvM6odvJoWPPfHa1ggJU",
            "c5SwFf_lISLiNvM6odvJoWPPfHa1ggJU",
            "25",
            "lassopeptides",
            "",
            "",
            "",
            "",
        ),
        (
            "antismash_20261",
            "antismash",
            "antismash/modules/lassopeptides/data/precursor_2637.socialgene.hmm.gz",
            "precursor_2637",
            "",
            "",
            "",
            "Fri Jun  3 18:22:47 2016",
            "rtitg1d_v3tZSWMbqW1GdXdZWL-WJfXk",
            "rtitg1d_v3tZSWMbqW1GdXdZWL-WJfXk",
            "43",
            "lassopeptides",
            "",
            "",
            "",
            "",
        ),
        (
            "antismash_20262",
            "antismash",
            "antismash/modules/lassopeptides/data/prec_II_2838.socialgene.hmm.gz",
            "prec_II_2838",
            "",
            "",
            "",
            "Fri Jun  3 18:50:51 2016",
            "G2iAAzc0r-R_zf-OmcTrYxsuxSNJN3Zy",
            "G2iAAzc0r-R_zf-OmcTrYxsuxSNJN3Zy",
            "46",
            "lassopeptides",
            "",
            "",
            "",
            "",
        ),
        (
            "antismash_20263",
            "antismash",
            "antismash/modules/rrefinder/data/RREFam.socialgene.hmm.gz",
            "Bottromycin_Methyltransferase_RRE",
            "RREFam008.1",
            "",
            "RRE-containing methyltransferase protein in a bottromycin cluster",
            "Sun May 12 17:51:42 2019",
            "zvgVMxbzcOG4ryUj4hE1Ymj7pPVBuLnO",
            "zvgVMxbzcOG4ryUj4hE1Ymj7pPVBuLnO",
            "236",
            "rrefinder",
            "",
            "",
            "",
            "",
        ),
        (
            "antismash_20264",
            "antismash",
            "antismash/modules/rrefinder/data/RREFam.socialgene.hmm.gz",
            "Cyanobactin_D_RRE",
            "RREFam007.1",
            "",
            "RRE-containing D protein in a cyanobactin cluster",
            "Mon May 13 18:28:16 2019",
            "v1dY-mbiEJOM-ShH6wt3sdl7gL2yKavl",
            "v1dY-mbiEJOM-ShH6wt3sdl7gL2yKavl",
            "251",
            "rrefinder",
            "",
            "",
            "",
            "",
        ),
        (
            "antismash_20292",
            "antismash",
            "antismash/modules/sactipeptides/data/non_biosyn_hmms/PF13304.socialgene.hmm.gz",
            "AAA_21",
            "PF13304.4",
            "PF13304.4_updated_to_PF13304.9",
            "AAA domain, putative AbiEii toxin, Type IV TA system",
            "Fri Apr 22 12:33:09 2016",
            "lwYUIDwHQs4eeFixI7wMXPkWkduHB-ga",
            "pcR7UifotPHbtf903mABIe-HrKFP0Ed1",
            "914",
            "sactipeptides",
            "",
            "27.00 27.00",
            "27.00 27.00",
            "26.90 26.90",
        ),
        (
            "antismash_20293",
            "antismash",
            "antismash/modules/sactipeptides/data/non_biosyn_hmms/PF07690.socialgene.hmm.gz",
            "MFS_1",
            "PF07690.14",
            "PF07690.14_updated_to_PF07690.19; Pfam-A.socialgene.hmm.gz was used instead of this model",
            "Major Facilitator Superfamily",
            "Sat Apr 23 22:19:24 2016",
            "I4HsuHzij1OAWklIkOtUL7HU1uY5kwGd",
            "I4HsuHzij1OAWklIkOtUL7HU1uY5kwGd",
            "1064",
            "sactipeptides",
            "",
            "32.60 32.60",
            "32.60 32.60",
            "32.50 32.50",
        ),
        (
            "antismash_20294",
            "antismash",
            "antismash/modules/sactipeptides/data/non_biosyn_hmms/PF00005.socialgene.hmm.gz",
            "PF00005",
            "PF00005.25",
            "PF00005.25_updated_to_PF00005.30",
            "ABC transporter",
            "Sat Apr 23 13:59:20 2016",
            "kpffyXNpoBeteRMQLrUbId9SR2U8gYla",
            "BLvMw-nbOjMmt9V5N2oUYyDzN7t1gylZ",
            "416",
            "sactipeptides",
            "",
            "23.10 23.10",
            "23.10 23.10",
            "23.00 23.00",
        ),
        (
            "antismash_20295",
            "antismash",
            "antismash/modules/sactipeptides/data/non_biosyn_hmms/PF02518.socialgene.hmm.gz",
            "HATPase_c",
            "PF02518.24",
            "PF02518.24_updated_to_PF02518.29",
            "Histidine kinase-, DNA gyrase B-, and HSP90-like ATPase",
            "Fri Apr 22 08:01:01 2016",
            "8l0FtSPw2WF-jI7sPA52AbA33xswQbPk",
            "QlqxintWnjlbg_JRs1Z01VN95C6sF8yi",
            "338",
            "sactipeptides",
            "",
            "23.80 22.70",
            "23.80 22.70",
            "23.70 22.60",
        ),
        (
            "antismash_20296",
            "antismash",
            "antismash/modules/sactipeptides/data/non_biosyn_hmms/PF00664.socialgene.hmm.gz",
            "ABC_membrane",
            "PF00664.21",
            "PF00664.21_updated_to_PF00664.26",
            "ABC transporter transmembrane region",
            "Thu Apr 21 10:06:38 2016",
            "sN0La5iVvzice5uTOEA8MjiN-etS8Oom",
            "rry25IG55p_Ds6kLC0fZuvkgboLDM2Va",
            "827",
            "sactipeptides",
            "",
            "24.20 21.70",
            "24.20 21.70",
            "24.10 21.60",
        ),
        (
            "antismash_20297",
            "antismash",
            "antismash/modules/sactipeptides/data/non_biosyn_hmms/PF00072.socialgene.hmm.gz",
            "Response_reg",
            "PF00072.22",
            "PF00072.22_updated_to_PF00072.27; Pfam-A.socialgene.hmm.gz was used instead of this model",
            "Response regulator receiver domain",
            "Thu Apr 21 12:24:53 2016",
            "WaVXBTiGhjumnHTF9pDQac-Aa4gU3ly0",
            "WaVXBTiGhjumnHTF9pDQac-Aa4gU3ly0",
            "341",
            "sactipeptides",
            "",
            "21.90 21.90",
            "21.90 21.90",
            "21.80 21.80",
        ),
        (
            "antismash_21083",
            "antismash",
            "antismash/detection/nrps_pks_domains/data/ksdomains.socialgene.hmm.gz",
            "Trans-AT-KS",
            "",
            "antismash/detection/hmm_detection/data/tra_KS.socialgene.hmm.gz was used instead of this model",
            "",
            "Thu Mar 18 15:02:35 2010",
            "n3xwUPOoysLtZxM4aX_yKtVGLA4s2VNU",
            "n3xwUPOoysLtZxM4aX_yKtVGLA4s2VNU",
            "1280",
            "nrps_pks_domains",
            "",
            "",
            "20.00 20.00",
            "",
        ),
    ]
    a = HmmInfo(hmm_metadata)
    a.read_tsv()
    assert expected == a.all_hmms_data
    assert 18 == len(a.all_hmms_data)


def test_write_nr_hmm_nodes():
    expected = [
        "9aoKRGqW5_z5zcCH8wulWF5an7D48XmM\n",
        "BLvMw-nbOjMmt9V5N2oUYyDzN7t1gylZ\n",
        "G2iAAzc0r-R_zf-OmcTrYxsuxSNJN3Zy\n",
        "I4HsuHzij1OAWklIkOtUL7HU1uY5kwGd\n",
        "NYiHn06Ms9lNw60zW13-sObNQrDXs4e7\n",
        "QlqxintWnjlbg_JRs1Z01VN95C6sF8yi\n",
        "WaVXBTiGhjumnHTF9pDQac-Aa4gU3ly0\n",
        "YR6F0nKMKCDSa43uLFirmdKy4vW_EbjM\n",
        "Z4Wkzo7ip6X5PBcNX8oZFu0VpW8QOb3F\n",
        "apGY0trpuFsy-yHsEO9UISlrhQx6TTLC\n",
        "c5SwFf_lISLiNvM6odvJoWPPfHa1ggJU\n",
        "n3xwUPOoysLtZxM4aX_yKtVGLA4s2VNU\n",
        "pcR7UifotPHbtf903mABIe-HrKFP0Ed1\n",
        "rry25IG55p_Ds6kLC0fZuvkgboLDM2Va\n",
        "rtitg1d_v3tZSWMbqW1GdXdZWL-WJfXk\n",
        "v1dY-mbiEJOM-ShH6wt3sdl7gL2yKavl\n",
        "vm8e9Y4xr6ioruVr7_GbwrvvHjdVdi4e\n",
        "zvgVMxbzcOG4ryUj4hE1Ymj7pPVBuLnO\n",
    ]
    a = HmmInfo(hmm_metadata)
    a.read_tsv()
    with tempfile.NamedTemporaryFile() as fp:
        a.write_nr_hmm_nodes(fp.name)
        with open(fp.name, "r") as h:
            z = h.readlines()
    z.sort()
    assert expected == z
